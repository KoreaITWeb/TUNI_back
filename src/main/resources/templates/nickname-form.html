<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>닉네임 설정</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .message { margin-top: 5px; font-size: 0.9em; }
        .success { color: green; }
        .fail { color: red; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h2>회원가입 - 닉네임 설정</h2>
    <p>사용하실 닉네임을 입력해주세요.</p>

    <form id="registerForm">
        <input type="hidden" id="email" name="email" th:value="${email}">
        <input type="hidden" id="code" name="code" th:value="${code}">

        <div>
            <label for="nickname">닉네임:</label><br>
            <input type="text" id="nickname" name="nickname" required>
            <button type="button" id="checkNicknameBtn">중복 확인</button>
            <div id="nicknameMessage" class="message"></div>
        </div>

        <div style="margin-top: 20px;">
            <button type="submit" id="submitBtn" disabled>가입 완료</button>
        </div>
    </form>

<script>
    const nicknameInput = document.getElementById('nickname');
    const checkBtn = document.getElementById('checkNicknameBtn');
    const submitBtn = document.getElementById('submitBtn');
    const messageDiv = document.getElementById('nicknameMessage');
    
    // 닉네임 입력 시, 다시 중복 확인을 하도록 상태 초기화
    nicknameInput.addEventListener('input', () => {
        submitBtn.disabled = true;
        messageDiv.textContent = '';
        messageDiv.className = 'message';
    });

    // '중복 확인' 버튼 클릭 이벤트
    checkBtn.addEventListener('click', async () => {
        const nickname = nicknameInput.value;
        if (!nickname || nickname.trim() === '') {
            alert('닉네임을 입력하세요.');
            return;
        }

        // 서버에 닉네임 중복 확인 요청
        const response = await fetch(`/api/auth/check-nickname?nickname=${nickname}`);
        const result = await response.json();

        if (result.available) {
            messageDiv.textContent = '✅ 사용 가능한 닉네임입니다.';
            messageDiv.className = 'message success';
            submitBtn.disabled = false; // 가입 완료 버튼 활성화
        } else {
            messageDiv.textContent = '❌ 이미 사용 중인 닉네임입니다.';
            messageDiv.className = 'message fail';
            submitBtn.disabled = true; // 가입 완료 버튼 비활성화
        }
    });

    // '가입 완료' 폼 제출 이벤트
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            email: document.getElementById('email').value,
            code: document.getElementById('code').value,
            nickname: nicknameInput.value
        };

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();

            if (response.ok) {
                alert('회원가입 성공! 메인 페이지로 이동합니다.');
                localStorage.setItem('accessToken', result.accessToken);
                window.location.href = '/product/register'; // 가입 후 이동할 페이지
            } else {
                alert('가입 실패: ' + (result.message || '다시 시도해주세요.'));
            }
        } catch (error) {
            alert('요청 중 에러가 발생했습니다.');
        }
    });
</script>
</body>
</html>