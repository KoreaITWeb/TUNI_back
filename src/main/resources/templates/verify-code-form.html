<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>인증 코드 입력</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .info { background-color: #f0f8ff; padding: 10px; border-radius: 5px; }
        input, button { padding: 8px; margin-top: 5px; }
    </style>
</head>
<body>
    <h2>인증 코드 입력</h2>
    
    <div class="info">
        <p><strong th:text="${email}"></strong> 주소로 발송된 인증 코드를 입력해주세요.</p>
    </div>

    <form id="verifyForm">
        <input type="hidden" id="email" name="email" th:value="${email}">
        
        <div style="margin-top: 15px;">
            <label for="code">인증 코드:</label><br>
            <input type="text" id="code" name="code" placeholder="6자리 숫자" required size="10" maxlength="6">
        </div>

        <div style="margin-top: 20px;">
            <button type="submit">인증 확인</button>
        </div>
    </form>

<script>
    const form = document.getElementById('verifyForm');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const email = document.getElementById('email').value;
        const code = document.getElementById('code').value;

        const formData = {
            email: email,
            code: code
        };

        try {
            const response = await fetch('/api/auth/verify-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                // ▼▼▼▼▼ 여기가 핵심 수정 부분입니다 ▼▼▼▼▼

                if (result.isNewUser) {
                    // [신규 회원일 경우]
                    alert('코드 인증 성공! 회원가입을 위해 닉네임 설정 페이지로 이동합니다.');
                    // 닉네임 설정 페이지로 이메일과 코드를 가지고 이동
                    window.location.href = `/register-form?email=${email}&code=${code}`;
                } else {
                    // [기존 회원일 경우]
                    alert('로그인 성공! 메인 페이지로 이동합니다.');
                    
                    // 응답에 포함된 토큰을 localStorage에 저장
                    localStorage.setItem('accessToken', result.token.accessToken);
                    localStorage.setItem('refreshToken', result.token.refreshToken);

                    // 로그인이 필요한 메인 페이지로 이동
                    window.location.href = '/main'; 
                }

            } else {
                alert('인증 실패: ' + (result.message || '코드를 다시 확인해주세요.'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('요청 중 에러가 발생했습니다.');
        }
    });
</script>
</body>
</html>