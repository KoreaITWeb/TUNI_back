<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>인증 코드 입력</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .info { background-color: #f0f8ff; padding: 10px; border-radius: 5px; }
        input, button { padding: 8px; margin-top: 5px; }
    </style>
</head>
<body>
    <h2>인증 코드 입력</h2>
    
    <div class="info">
        <p><strong th:text="${email}"></strong> 주소로 발송된 인증 코드를 입력해주세요.</p>
    </div>

    <form id="verifyForm">
        <input type="hidden" id="email" name="email" th:value="${email}">
        
        <div style="margin-top: 15px;">
            <label for="code">인증 코드:</label><br>
            <input type="text" id="code" name="code" placeholder="6자리 숫자" required size="10" maxlength="6">
        </div>

        <div style="margin-top: 20px;">
            <button type="submit">로그인</button>
        </div>
    </form>

<script>
    // 폼(form) 요소를 가져옵니다.
    const form = document.getElementById('verifyForm');

    // 폼에서 'submit' 이벤트가 발생했을 때 실행할 함수를 등록합니다.
    form.addEventListener('submit', async (event) => {
        // 1. 폼의 기본 제출 동작(페이지 새로고침)을 막습니다.
        event.preventDefault();

        // 2. 폼에서 이메일과 코드 값을 가져옵니다.
        const email = document.getElementById('email').value;
        const code = document.getElementById('code').value;

        // 3. 서버로 보낼 데이터를 JSON 형식으로 만듭니다.
        const formData = {
            email: email,
            code: code
        };

        try {
            // 4. fetch API를 사용해 서버의 '/api/auth/verify-code'로 POST 요청을 보냅니다.
            const response = await fetch('/api/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            // 5. 서버로부터 응답을 JSON 형태로 파싱합니다.
            const result = await response.json();

            // 6. 응답 상태를 확인합니다.
            if (response.ok) {
                // 성공 시 (HTTP 상태 코드 200-299)
                alert('로그인 성공! 메인 페이지로 이동합니다.');
                
                // 받은 토큰을 localStorage에 저장합니다. (웹 브라우저 저장소)
                localStorage.setItem('accessToken', result.accessToken);
                localStorage.setItem('refreshToken', result.refreshToken);

                // 로그인이 필요한 메인 페이지로 이동합니다.
                window.location.href = '/main'; // 예: 메인 페이지 경로
            } else {
                // 실패 시 (HTTP 상태 코드 4xx, 5xx)
                // 서버가 보낸 에러 메시지를 alert로 보여줍니다.
                alert('인증 실패: ' + (result.message || '코드를 다시 확인해주세요.'));
            }
        } catch (error) {
            // 네트워크 에러 등 통신 자체에 실패했을 때
            console.error('Error:', error);
            alert('요청 중 에러가 발생했습니다.');
        }
    });
</script>
</body>
</html>